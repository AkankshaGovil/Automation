#!/usr/bin/env python
"""
File Name       :       mailer.py
File Owner      :       Vijender
Description     :       It sends the mail to the respective manager when an
                        instance of this module is called for ticket #26365

History         : Modified By           Date            Description
                  -----------           ----            -----------
                    Vijender          10/07/2006     Sends the mail
		                                     to the respective manager
       		                                     when this module is called.
                                   
Import          :
"""                                 
					    
from smtplib import * 
import string
import logging



"classes"

class MailerError(Exception):
    """
    General mailer error
    """

class Mailer(object):
	
    """ 
    This will mail to the respective manager when an instance of this is called.
    """
    
#Functions

    def __init__(self,toaddr=None,fromaddr=None,mailserver=None,login=None,passwd=None) :
	 """ 
	 Mailer instance is created fro initialization.

          The arguments are:

               - from_addr    : The address sending this mail.
               - to_addrs     : A list of addresses to send this mail to.  A bare
                                string will be treated as a list with 1 address.
               - mailserver   : mailserver through which mails will be sent. 
               - login        : Login name for user authentication while sending mails.
               - passwd       : Passwd for user authentication while sending mails.

	 """
         self.log = logging.getLogger('nextestlog')
         self.toaddrs = toaddr
         self.fromaddr = fromaddr
         self.mailserver = mailserver
         # Two parameters added for user authentication
         self.login = login
         self.passwd = passwd

    def sendMail(self,subject,msg) :
        """
        The main function that is used for sending the mail.

        The arguments are: 

               - subject     : Subject of this mail.
               - msg         : text body of the mail to be sent
        """ 
        self.subject = subject
        try :
            s_toaddrs = string.join(self.toaddrs,",")
        except :
            self.log.error("Error : The to-address %s is errorneous" %self.toaddrs)
            raise MailerError("Exception : The toaddress is errorneous")
       	self.msg = ("From: %s\r\nTo: %s\r\nSubject: %s\r\n\r\n"\
                    % (self.fromaddr,s_toaddrs,self.subject))
        self.msg += msg

        try :
	    server = SMTP(self.mailserver)
        except :
            self.log.error("The Error in the connection to %s mailserver"% self.mailserver)
            raise MailerError("Exception : Unable to connect to mailserver")
        # Fix for ticket 34247 for handling user authentication and sending mails
        # to multiple recipients.
        try :
            server.login(self.login,self.passwd)
        except :
            self.log.error("Exception : Error in login or passwd value as exception %s is thrown" % str(e))
            raise MailerError("Exception : Error in authentication because of exception %s" %str(e))
            
        try :
            server.sendmail(self.fromaddr, self.toaddrs, self.msg)
        except SMTPHeloError, e:
            self.log.error("Exception : Error in response from server as exception %s is thrown" % str(e))
            raise MailerError("Exception : Error in iresponse from server because of exception %s" %str(e))
        except SMTPSenderRefused, e:
            self.log.error("Exception : Error in fromaddr as exception %s is thrown" %str(e))     
            raise MailerError("Exception : Error in fromaddress because of exception %s" %str(e))                     
        except SMTPRecipientsRefused, e:
            self.log.error("Exception : Error in toaddress as exception %s is thrown" % str(e))   
            raise MailerError("Exception : Error in toaddress because of exceptio %s" %str(e))                        
        except SMTPDataError, e:
            self.log.error("Exception : Error in mailserver as exception %s is thrown" % str(e)) 
            raise MailerError("Exception : Error in mailserver name because of exception %s" %str(e)) 
        except :
            self.log.error("Exception : The value assigned to to-addressess %s and from-address %s is errorneous" %(self.toaddrs,self.fromaddr))
            raise MailerError("Exception :The value assigned to to-addressess %s and from-address %s is errorneous" %(self.toaddrs,self.fromaddr))
 
            
        server.quit()

